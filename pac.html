<html>

<head>
</head>

<body>
    <div id='d1' style="position:absolute; top: 0px; left: 0px; z-index:1">
        <canvas id="ctx1" width=window.innerWidth height=window.innerHeight> </canvas>
    </div>
    <div id='d2' style="position:absolute; top: 0px; left: 0px; z-index:2">
        <canvas id="ctx2" width=window.innerWidth height=window.innerHeight> </canvas>
    </div>
    <div id='d3' style="position:absolute; top: 0px; left: 0px; z-index:3">
        <canvas id="ctx3" width=window.innerWidth height=window.innerHeight> </canvas>
    </div>
    <script>
        if (typeof Pac == 'undefined') {
            class Pac {
                constructor(x, y, block_y, block_x, direction, color, state, r) {
                    this.x = x;
                    this.y = y;
                    this.block_y = block_y;
                    this.block_x = block_x;
                    this.direction = direction;
                    this.color = color;
                    this.state = state;
                    this.r = r;
                }
            }

            class Ghost {
                constructor(x, y, block_x, block_y, ghost_step, state, direction, color, r) {
                    this.x = x;
                    this.y = y;
                    this.block_x = block_x;
                    this.block_y = block_y;
                    this.ghost_step = ghost_step;
                    this.state = state;
                    this.direction = direction;
                    this.prev_direction = direction;
                    this.color = color;
                    this.r = r;
                }
            }

            let x, y, r, count, range, coord, state, step, ghost_step, micro_step, curr_direction, obj, game, a, ghost_r, pac_r, pac, red_Ghost, blue_Ghost, brown_Ghost, violet_Ghost, ctx1, ctx2, ctx3, animationID, level = 1, level_quantity = 3, map;

            function get_block_coord(i, j, a) {
                return { x1: j * a, y1: i * a, x2: j * a + a, y2: i * a + a };
            }

            function get_ghost_block(ghost_obj, map, a) {
                let block_coords;
                for (let i = 0; i < map.length; i++) {
                    for (let j = 0; j < map[0].length; j++) {
                        block_coords = get_block_coord(i, j, a);
                        if ((ghost_obj.x == block_coords.x1) && (ghost_obj.y == block_coords.y1)) {
                            return { block_x: j, block_y: i };
                        }
                    }
                }
            }

            function draw_block(ctx, x, y, color) {
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.rect(x, y, a, a);
                ctx.stroke();
                ctx.fill();
            }
            function draw_circle(x, y, r, color, ctx) {
                ctx.beginPath();
                ctx.fillStyle = color;
                if (color == "black") {
                    ctx.arc(x + a, y + a, r / 2 + 1, 0, 2 * Math.PI);
                } else {
                    ctx.arc(x + a, y + a, r / 2, 0, 2 * Math.PI);
                }
                ctx.fill();
            }

            function draw_map(ctx, map) {
                ctx.beginPath();
                for (let i = 0; i < map.length; i++) {
                    for (let j = 0; j < map[i].length; j++) {
                        if (map[i][j] == 1) {
                            draw_block(ctx, a * j, a * i, "green");
                        } else if (map[i][j] == 2) {
                            draw_circle(a * j, a * i, r, "IndianRed", ctx);
                        }
                    }
                }
                return ctx;
            }

            function draw_ghost(ghost, color, ctx) {
                let add = 1;
                ctx.beginPath();
                ctx.fillStyle = color;
                ctx.arc(ghost.x, ghost.y, ghost.r, 0, Math.PI, true);
                ctx.rect(ghost.x - ghost.r, ghost.y, 2 * ghost.r, ghost.r / 2);
                ctx.fill();

                ctx.moveTo(ghost.x - ghost.r, ghost.y + ghost.r / 2);
                ctx.lineTo(ghost.x - ghost.r + ghost.r / 4, ghost.y + ghost.r);
                ctx.lineTo(ghost.x - ghost.r + ghost.r / 2, ghost.y + ghost.r / 2);
                ctx.lineTo(ghost.x - ghost.r + 3 * ghost.r / 4, ghost.y + ghost.r);
                ctx.lineTo(ghost.x - ghost.r + ghost.r, ghost.y + ghost.r / 2);
                ctx.lineTo(ghost.x - ghost.r + 5 * ghost.r / 4, ghost.y + ghost.r);
                ctx.lineTo(ghost.x - ghost.r + 3 * ghost.r / 2, ghost.y + ghost.r / 2);
                ctx.lineTo(ghost.x - ghost.r + 7 * ghost.r / 4, ghost.y + ghost.r);
                ctx.lineTo(ghost.x - ghost.r + 2 * ghost.r, ghost.y + ghost.r / 2);

                ctx.fill();

                ctx.beginPath();
                ctx.fillStyle = "white";
                ctx.arc(ghost.x - 2 * ghost.r / 5, ghost.y, ghost.r / 5, 0, 2 * Math.PI);
                ctx.arc(ghost.x + 2 * ghost.r / 5, ghost.y, ghost.r / 5, 0, 2 * Math.PI);
                ctx.fill();

                ctx.beginPath();
                ctx.fillStyle = "black";
                ctx.arc(ghost.x - 2 * ghost.r / 5, ghost.y, ghost.r / 10, 0, 2 * Math.PI);
                ctx.arc(ghost.x + 2 * ghost.r / 5, ghost.y, ghost.r / 10, 0, 2 * Math.PI);
                ctx.fill();
            }

            function clear_ghost(ghost, ctx) {
                ctx.clearRect(ghost.x - ghost.r - 1, ghost.y - ghost.r - 1, 2 * ghost.r + 2, 2 * ghost.r + 2);
            }

            function get_direct(ghost_obj) {
                let r;
                switch (ghost_obj.direction) {
                    case "left":
                        if (((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) ||
                            (((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y > 2)) ||
                            (((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y < 20))) {

                            if (((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) &&
                                (((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y > 2)) &&
                                ((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1) && (ghost_obj.block_y < 20))) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "left";
                                } else if (r <= 0.75) {
                                    return "up";
                                } else {
                                    return "down";
                                }
                            } else if (((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) &&
                                ((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y > 2)) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "left";
                                } else {
                                    return "up";
                                }
                            } else if (((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y > 2) &&
                                ((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1) && (ghost_obj.block_y < 20))) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "up";
                                } else {
                                    return "down";
                                }
                            } else if (((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) &&
                                ((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1) && (ghost_obj.block_y < 20))) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "left";
                                } else {
                                    return "down";
                                }
                            } else if ((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) {
                                return "left";
                            } else if ((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1) && (ghost_obj.block_y > 2)) {
                                return "up";
                            } else if ((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1) && (ghost_obj.block_y < 20)) {
                                return "down";
                            }

                        } else {
                            return "right";
                        }
                    case "up":
                        if (((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) ||
                            (((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y > 2)) ||
                            ((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1))) {

                            if (((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) &&
                                ((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y > 2) &&
                                ((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1))) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "up";
                                } else if (r <= 0.75) {
                                    return "left";
                                } else {
                                    return "right";
                                }
                            } else if (((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) &&
                                ((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y > 2)) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "left";
                                } else {
                                    return "up";
                                }
                            } else if (((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y > 2) &&
                                ((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1))) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "up";
                                } else {
                                    return "right";
                                }
                            } else if (((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) &&
                                ((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1))) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "left";
                                } else {
                                    return "right";
                                }
                            } else if ((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) {
                                return "left";
                            } else if ((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1) && (ghost_obj.block_y > 2)) {
                                return "up";
                            } else if (((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1))) {
                                return "right";
                            }

                        } else {
                            return "down";
                        }
                    case "right":
                        if ((((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y > 2)) ||
                            (((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1))) ||
                            ((((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1))) && ((map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y < 20))) {

                            if (((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y > 2) &&
                                (((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1))) &&
                                (((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1))) && ((map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1) && (ghost_obj.block_y < 20))) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "right";
                                } else if (r <= 0.75) {
                                    return "up";
                                } else {
                                    return "down";
                                }
                            } else if (((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y > 2) &&
                                (((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1)))) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "right";
                                } else {
                                    return "up";
                                }
                            } else if ((((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1))) &&
                                (((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1))) && ((map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1) && (ghost_obj.block_y < 20))) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "right";
                                } else {
                                    return "down";
                                }
                            } else if (((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y > 2) &&
                                (((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1))) && ((map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1) && (ghost_obj.block_y < 20))) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "up";
                                } else {
                                    return "down";
                                }
                            } else if ((map[ghost_obj.block_y - 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y - 1][ghost_obj.block_x + 1] != 1) && (ghost_obj.block_y > 2)) {
                                return "up";
                            } else if (((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1))) {
                                return "right";
                            } else if ((((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1))) && ((map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1) && (ghost_obj.block_y < 20))) {
                                return "down";
                            }

                        } else {
                            return "left";
                        }
                    case "down":
                        if (((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) ||
                            (((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1))) ||
                            ((((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1))) && (ghost_obj.block_y < 20))) {

                            if (((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) &&
                                (((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1))) &&
                                (((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1)) && (ghost_obj.block_y < 20))) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "down";
                                } else if (r <= 0.75) {
                                    return "left";
                                } else {
                                    return "right";
                                }
                            } else if (((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) &&
                                (((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1)))) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "left";
                                } else {
                                    return "right";
                                }
                            } else if ((((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1))) &&
                                (((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1) && (ghost_obj.block_y < 20)))) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "down";
                                } else {
                                    return "right";
                                }
                            } else if (((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) &&
                                (((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1) && (ghost_obj.block_y < 20)))) {
                                r = Math.random();
                                if (r <= 0.5) {
                                    return "down";
                                } else {
                                    return "left";
                                }
                            } else if ((map[ghost_obj.block_y][ghost_obj.block_x - 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x - 1] != 1)) {
                                return "left";
                            } else if (((map[ghost_obj.block_y][ghost_obj.block_x + 1] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y][ghost_obj.block_x + 2] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 2] != 1))) {
                                return "right";
                            } else if (((map[ghost_obj.block_y + 1][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 1][ghost_obj.block_x + 1] != 1)) && ((map[ghost_obj.block_y + 2][ghost_obj.block_x] != 1) && (map[ghost_obj.block_y + 2][ghost_obj.block_x + 1] != 1) && (ghost_obj.block_y < 20))) {
                                return "down";
                            }

                        } else {
                            return "up";
                        }
                }
            }

            function move_ghost(ghost_obj) {
                let block_indexes, block_coords;
                if (ghosts_vs_pac(pac)) {
                    clearInterval(animationID);
                }
                if (ghost_obj.state == "movement") {
                    clear_ghost(ghost_obj, ctx3);
                    if (ghost_obj.direction == "left") {
                        block_coords = get_block_coord(ghost_obj.block_y, ghost_obj.block_x - 1, a);
                        if ((ghost_obj.x - block_coords.x2) >= ghost_obj.ghost_step) {
                            ghost_obj.x -= ghost_obj.ghost_step;
                        } else {
                            ghost_obj.x = block_coords.x2;
                            ghost_obj.block_x -= 1;
                            ghost_obj.prev_direction = ghost_obj.direction;
                            ghost_obj.state = "get_direction";
                        }
                        draw_ghost(ghost_obj, ghost_obj.color, ctx3);
                    } else if (ghost_obj.direction == "up") {
                        block_coords = get_block_coord(ghost_obj.block_y - 1, ghost_obj.block_x, a);
                        if ((ghost_obj.y - block_coords.y2) >= ghost_obj.ghost_step) {
                            ghost_obj.y -= ghost_obj.ghost_step;
                        } else {
                            ghost_obj.y = block_coords.y2;
                            ghost_obj.block_y -= 1;
                            ghost_obj.prev_direction = ghost_obj.direction;
                            ghost_obj.state = "get_direction";
                        }
                        draw_ghost(ghost_obj, ghost_obj.color, ctx3);
                    } else if (ghost_obj.direction == "right") {
                        block_coords = get_block_coord(ghost_obj.block_y, ghost_obj.block_x + 1, a);
                        if ((block_coords.x2 - ghost_obj.x) >= ghost_obj.ghost_step) {
                            ghost_obj.x += ghost_obj.ghost_step;
                        } else {
                            ghost_obj.x = block_coords.x2;
                            ghost_obj.block_x += 1;
                            ghost_obj.prev_direction = ghost_obj.direction;
                            ghost_obj.state = "get_direction";
                        }
                        draw_ghost(ghost_obj, ghost_obj.color, ctx3);
                    } else if (ghost_obj.direction == "down") {
                        block_coords = get_block_coord(ghost_obj.block_y + 1, ghost_obj.block_x, a);
                        if ((block_coords.y2 - ghost_obj.y) >= ghost_obj.ghost_step) {
                            ghost_obj.y += ghost_obj.ghost_step;
                        } else {
                            ghost_obj.y = block_coords.y2;
                            ghost_obj.block_y += 1;
                            ghost_obj.prev_direction = ghost_obj.direction;
                            ghost_obj.state = "get_direction";
                        }
                        draw_ghost(ghost_obj, ghost_obj.color, ctx3);
                    }
                } else if (ghost_obj.state == "get_direction") {
                    ghost_obj.direction = get_direct(ghost_obj);
                    ghost_obj.state = "movement";
                }
            }

            function get_block_pos(y, x, a) {
                let block_y, block_x;
                if ((y % a) == 0) {
                    block_y = y / a - 1;
                } else {
                    block_y = Math.floor(y / a);
                }
                if ((x % a) == 0) {
                    block_x = x / a - 1;
                } else {
                    block_x = Math.floor(x / a);
                }
                return { block_y, block_x };
            }

            function check_pac_pos(pac, step, a, ctx, direction) {
                let x1, y1, x2, y2, block_1, block_2, block_3, block_4, block_x, block_y, coords;
                switch (direction) {
                    case 'left':
                        x1 = pac.x - step - pac.r;
                        y1 = pac.y - pac.r;
                        x2 = pac.x - step + pac.r;
                        y2 = pac.y + pac.r;
                        break;
                    case 'up':
                        x1 = pac.x - pac.r;
                        y1 = pac.y - step - pac.r;
                        x2 = pac.x + pac.r;
                        y2 = pac.y - step + pac.r;
                        break;
                    case 'right':
                        x1 = pac.x + step - pac.r;
                        y1 = pac.y - pac.r;
                        x2 = pac.x + step + pac.r;
                        y2 = pac.y + pac.r;
                        break;
                    case 'down':
                        x1 = pac.x - pac.r;
                        y1 = pac.y + step - pac.r;
                        x2 = pac.x + pac.r;
                        y2 = pac.y + step + pac.r;
                        break;
                }
                block_1 = get_block_pos(y1, x1, a);
                block_2 = get_block_pos(y1, x2, a);
                block_3 = get_block_pos(y2, x1, a);
                block_4 = get_block_pos(y2, x2, a);

                for (let i = block_1.block_y; i <= block_3.block_y; i++) {
                    for (let j = block_1.block_x; j <= block_4.block_x; j++) {
                        if (map[i][j] == 1) {
                            return { bool: true, row: i, col: j };
                        }
                    }
                }

                if (map[block_1.block_y - 1][block_1.block_x - 1] == 2) {
                    coords = get_block_coord(block_1.block_y - 1, block_1.block_x - 1, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_1.block_y - 1][block_1.block_x - 1] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_1.block_y - 1][block_1.block_x] == 2) {
                    coords = get_block_coord(block_1.block_y - 1, block_1.block_x, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_1.block_y - 1][block_1.block_x] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_1.block_y][block_1.block_x - 1] == 2) {
                    coords = get_block_coord(block_1.block_y, block_1.block_x - 1, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_1.block_y][block_1.block_x - 1] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_1.block_y][block_1.block_x] == 2) {
                    coords = get_block_coord(block_1.block_y, block_1.block_x, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_1.block_y][block_1.block_x] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_2.block_y - 1][block_2.block_x] == 2) {
                    coords = get_block_coord(block_2.block_y - 1, block_2.block_x, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_2.block_y - 1][block_2.block_x] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_2.block_y - 1][block_2.block_x + 1] == 2) {
                    coords = get_block_coord(block_2.block_y + 1, block_2.block_x + 1, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_2.block_y - 1][block_2.block_x + 1] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_2.block_y][block_2.block_x] == 2) {
                    coords = get_block_coord(block_2.block_y, block_2.block_x, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_2.block_y][block_2.block_x] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_2.block_y][block_2.block_x + 1] == 2) {
                    coords = get_block_coord(block_2.block_y, block_2.block_x + 1, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_2.block_y][block_2.block_x + 1] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_3.block_y][block_3.block_x - 1] == 2) {
                    coords = get_block_coord(block_3.block_y, block_3.block_x - 1, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_3.block_y][block_1.block_x - 1] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_3.block_y][block_3.block_x] == 2) {
                    coords = get_block_coord(block_3.block_y, block_3.block_x, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_3.block_y][block_1.block_x] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_3.block_y + 1][block_3.block_x - 1] == 2) {
                    coords = get_block_coord(block_3.block_y + 1, block_3.block_x - 1, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_3.block_y + 1][block_3.block_x - 1] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_3.block_y + 1][block_3.block_x] == 2) {
                    coords = get_block_coord(block_3.block_y + 1, block_3.block_x, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_3.block_y + 1][block_3.block_x] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_4.block_y][block_4.block_x] == 2) {
                    coords = get_block_coord(block_4.block_y, block_4.block_x, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_4.block_y][block_4.block_x] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_4.block_y][block_4.block_x + 1] == 2) {
                    coords = get_block_coord(block_4.block_y, block_4.block_x + 1, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_4.block_y][block_4.block_x + 1] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_4.block_y + 1][block_4.block_y] == 2) {
                    coords = get_block_coord(block_4.block_y + 1, block_4.block_x, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_4.block_y + 1][block_4.block_x] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                if (map[block_4.block_y + 1][block_4.block_x + 1] == 2) {
                    coords = get_block_coord(block_4.block_y + 1, block_4.block_x + 1, a);
                    block_x = coords.x1 + a;
                    block_y = coords.y1 + a;

                    if (Math.sqrt(Math.pow(block_x - x1 - pac.r, 2) + Math.pow(block_y - y1 - pac.r, 2)) <= 3 * pac.r / 2) {
                        map[block_4.block_y + 1][block_4.block_x + 1] = 0;
                        draw_circle(coords.x1, coords.y1, pac.r, "black", ctx);
                        win_check();
                    }
                }

                return { bool: false, row: -1, col: -1 };
            }

            function draw_pac(pac, color, ctx) {
                let region = new Path2D();
                let add = 1;

                ctx.beginPath();

                ctx.strokeStyle = color || pac.color;
                ctx.strokeWidth = 10;
                ctx.lineWidth = 10;
                ctx.fillStyle = color || pac.color;
                if (pac.state == "open") {
                    if (pac.direction == "right") {
                        region.arc(pac.x, pac.y, pac.r, Math.PI / 5, 9 * Math.PI / 5);
                        region.lineTo(pac.x, pac.y);
                        region.lineTo(pac.x + Math.cos(Math.PI / 5) * pac.r, pac.y + Math.cos(3 * Math.PI / 10) * pac.r);
                        pac.state = "close";

                    } else if (pac.direction == "up") {
                        region.arc(pac.x, pac.y, pac.r, -3 * Math.PI / 10, 13 * Math.PI / 10);
                        region.lineTo(pac.x, pac.y);
                        region.lineTo(pac.x + Math.cos(3 * Math.PI / 10) * pac.r, pac.y - Math.cos(Math.PI / 5) * pac.r);
                        pac.state = "close";

                    } else if (pac.direction == "left") {
                        region.arc(pac.x, pac.y, pac.r, 6 * Math.PI / 5, 4 * Math.PI / 5);
                        region.lineTo(pac.x, pac.y);
                        region.lineTo(pac.x - Math.cos(Math.PI / 5) * pac.r, pac.y - Math.cos(3 * Math.PI / 10) * pac.r);
                        pac.state = "close";

                    } else if (pac.direction == "down") {
                        region.arc(pac.x, pac.y, pac.r, 7 * Math.PI / 10, 3 * Math.PI / 10);
                        region.lineTo(pac.x, pac.y);
                        region.lineTo(pac.x - Math.cos(3 * Math.PI / 10) * pac.r, pac.y + Math.cos(Math.PI / 5) * pac.r);
                        pac.state = "close";

                    }
                } else {
                    region.arc(pac.x, pac.y, pac.r, 0, 2 * Math.PI);
                    pac.state = "open";
                    count = 0;
                }
                ctx.fill(region, 'evenodd');
                region.closePath();
                return pac;
            }

            function ghost_vs_pac(pac, ghost) {
                if ((Math.abs(pac.x - ghost.x) < ghost.r + pac.r - 10) && (Math.abs(pac.y - ghost.y) < ghost.r + pac.r - 10)) {
                    if (game) {
                        alert('game over!');
                    }
                    return true;
                } else {
                    return false;
                }
            }

            function win_check() {
                for (let i = 0; i < map.length; i++) {
                    for (let j = 0; j < map[0].length; j++) {
                        if (map[i][j] == 2) {
                            return false;
                        }
                    }
                }
                if (level == level_quantity) {
                    alert('You win in the game!');
                    clearInterval(animationID);
                    game = false;
                    return true;
                } else {
                    level++;
                    init(level);
                }
            }

            function ghosts_vs_pac(pac) {
                if (ghost_vs_pac(pac, red_Ghost)) {
                    game = false;
                    return true;
                }
                if (ghost_vs_pac(pac, blue_Ghost)) {
                    game = false;
                    return true;
                }
                if (ghost_vs_pac(pac, brown_Ghost)) {
                    game = false;
                    return true;
                }
                if (ghost_vs_pac(pac, violet_Ghost)) {
                    game = false;
                    return true;
                }
                return false;
            }

            function clear_pac(pac, ctx) {
                ctx.fillStyle = "black";
                ctx.strokeStyle = "black";
                let region = new Path2D();
                region.color = "black";
                region.arc(pac.x, pac.y, pac.r + 1, 0, 2 * Math.PI);
                region.closePath();
                ctx.fill(region, 'evenodd');
            }

            function loop() {

                move_ghost(red_Ghost);
                move_ghost(blue_Ghost);
                move_ghost(brown_Ghost);
                move_ghost(violet_Ghost);

            }

            function read_map(res) {
                let map = [];
                let s = [];
                if (res.length > 0) {
                    let i = 0, j = 0;
                    while (i < res.length) {
                        if ((res[i] != ' ') && (res[i] != '\n') && (!isNaN(parseInt(res[i])))) {
                            s.push(res[i])
                        } else if (res[i] == '\n') {
                            map.push(s);
                            s = [];
                        }
                        i++;
                    }
                    map.push(s);
                    return map;
                } else {
                    return null;
                }
            }

            function init(stage = 1) {
                if (stage == 1) {
                    r = (window.innerWidth - 10) / 65;
                    pac_r = r;
                    a = 1.3 * r;
                    y = 23 * a;
                    x = 25 * a;
                    step = (window.innerWidth - 10) / 140;
                    animationID = setInterval(loop, 1000.0 / 30.0);
                }
                //level = stage;
                let body = 'stage=' + encodeURIComponent(stage);
                let xhr = new XMLHttpRequest();
                xhr.open('POST', '/read_map', true);
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
                        map = read_map(xhr.responseText);
                        ghost_step = 3 * (step) / 10;
                        ghost_r = a - 4;
                        state = "open";
                        curr_direction = "up";
                        //x, y, block_y, block_x, direction, color, state, r
                        pac = new Pac(x, y, 22, 24, "up", "yellow", "open", pac_r);

                        red_Ghost = new Ghost(24 * a, 9 * a, 23, 8, ghost_step, "movement", "left", "red", ghost_r);
                        blue_Ghost = new Ghost(27 * a, 9 * a, 26, 8, ghost_step, "movement", "right", "blue", ghost_r);
                        brown_Ghost = new Ghost(24 * a, 12 * a, 23, 11, ghost_step, "movement", "left", "Sienna", ghost_r);
                        violet_Ghost = new Ghost(27 * a, 12 * a, 26, 11, ghost_step, "movement", "right", "DarkOrchid", ghost_r);

                        count = 0;
                        range = 0;

                        ctx1 = document.getElementById("ctx1").getContext("2d");
                        ctx1.canvas.width = window.innerWidth - 5;
                        ctx1.canvas.height = window.innerHeight - 5;
                        ctx1.beginPath();
                        ctx1.fillStyle = "black";
                        ctx1.rect(0, 0, window.innerWidth, window.innerHeight);
                        ctx1.fill();

                        ctx2 = document.getElementById("ctx2").getContext("2d");
                        ctx2.canvas.width = window.innerWidth - 5;
                        ctx2.canvas.height = window.innerHeight - 5;
                        draw_map(ctx2, map);

                        ctx3 = document.getElementById("ctx3").getContext("2d");
                        ctx3.canvas.width = window.innerWidth - 5;
                        ctx3.canvas.height = window.innerHeight - 5;

                        game = true;
                        draw_pac(pac, "yellow", ctx2);
                    }
                }
                xhr.send(body);
            }

            init();
            window.onkeydown = function (event) {
                if (game) {
                    switch (event.keyCode) {
                        case 37:
                            if ((pac.direction == "left") && (count >= range)) {
                                count = 0;
                                obj = check_pac_pos(pac, step, a, ctx2, "left");
                                if (!obj.bool) {
                                    clear_pac(pac, ctx2);
                                    pac.x -= step;
                                    pac = draw_pac(pac, null, ctx2);
                                } else {
                                    coord = get_block_coord(obj.row, obj.col, a);
                                    if (map[obj.row][obj.col] == 1) {
                                        micro_step = pac.x - coord.x2 - pac.r - 3;
                                        if (micro_step > 0) {
                                            clear_pac(pac, ctx2);
                                            pac.x -= micro_step;
                                            pac = draw_pac(pac, null, ctx2);
                                        }
                                    }
                                }
                            } else if (pac.direction != "left") {
                                pac.direction = "left";
                                count = 1;
                            } else {
                                count++;
                            }
                            if (ghosts_vs_pac(pac)) {
                                clearInterval(animationID);
                            }
                            break;
                        case 38:
                            if ((pac.y - pac.r) > 0) {
                                if ((pac.direction == "up") && (count >= range)) {
                                    count = 0;
                                    obj = check_pac_pos(pac, step, a, ctx2, "up");
                                    if (!obj.bool) {
                                        clear_pac(pac, ctx2);
                                        pac.y -= step;
                                        pac = draw_pac(pac, null, ctx2);
                                    } else {
                                        coord = get_block_coord(obj.row, obj.col, a);
                                        if (map[obj.row][obj.col] == 1) {
                                            micro_step = pac.y - coord.y2 - pac.r - 3;
                                            if (micro_step > 0) {
                                                clear_pac(pac, ctx2);
                                                pac.y -= micro_step;
                                                pac = draw_pac(pac, null, ctx2);
                                            }
                                        }
                                    }
                                } else if (pac.direction != "up") {
                                    pac.direction = "up";
                                    count = 1;
                                } else {
                                    count++;
                                }
                                if (ghosts_vs_pac(pac)) {
                                    clearInterval(animationID);
                                }
                            }
                            break;
                        case 39:
                            if ((pac.direction == "right") && (count >= range)) {
                                count = 0;
                                obj = check_pac_pos(pac, step, a, ctx2, "right");
                                if (!obj.bool) {
                                    clear_pac(pac, ctx2);
                                    pac.x += step;
                                    pac = draw_pac(pac, null, ctx2);
                                } else {
                                    coord = get_block_coord(obj.row, obj.col, a);
                                    if (map[obj.row][obj.col] == 1) {
                                        micro_step = coord.x1 - pac.r - pac.x - 3;
                                        if (micro_step > 0) {
                                            clear_pac(pac, ctx2);
                                            pac.x += micro_step;
                                            pac = draw_pac(pac, null, ctx2);
                                        }
                                    }
                                }
                            } else if (pac.direction != "right") {
                                pac.direction = "right";
                                count = 1;
                            } else {
                                count++;
                            }
                            if (ghosts_vs_pac(pac)) {
                                clearInterval(animationID);
                            }
                            break;
                        case 40:
                            if ((pac.y + pac.r) < ctx2.canvas.height) {
                                if ((pac.direction == "down") && (count >= range)) {
                                    count = 0;
                                    obj = check_pac_pos(pac, step, a, ctx2, "down");
                                    if (!obj.bool) {
                                        clear_pac(pac, ctx2);
                                        pac.y += step;
                                        pac = draw_pac(pac, null, ctx2);
                                    } else {
                                        coord = get_block_coord(obj.row, obj.col, a);
                                        if (map[obj.row][obj.col] == 1) {
                                            micro_step = coord.y1 - pac.r - pac.y - 3;
                                            if (micro_step > 0) {
                                                clear_pac(pac, ctx2);
                                                pac.y += micro_step;
                                                pac = draw_pac(pac, null, ctx2);
                                            }
                                        }
                                    }
                                } else if (curr_direction != "down") {
                                    pac.direction = "down";
                                    count = 1;
                                } else {
                                    count++;
                                }
                                if (ghosts_vs_pac(pac)) {
                                    clearInterval(animationID);
                                }
                            }
                            break;
                        case 27:
                            clearInterval(animationID);
                            let xhr = new XMLHttpRequest();
                            xhr.open('GET', '/start', true);
                            xhr.onreadystatechange = function () {
                                if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
                                    let txt = xhr.responseText;
                                    document.clear();
                                    document.close();
                                    document.write(txt);
                                }
                            }
                            xhr.send();
                            break;
                    }
                } else {
                    if (event.keyCode == 27) {
                        let xhr = new XMLHttpRequest();
                        xhr.open('GET', '/start', true);
                        xhr.onreadystatechange = function () {
                            if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
                                let txt = xhr.responseText;
                                document.clear();
                                document.close();
                                document.write(txt);
                            }
                        }
                        xhr.send();
                    }
                }
            }
        } else {
            init();
        }
    </script>
</body>

</html>